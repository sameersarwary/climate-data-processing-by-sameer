
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Climate data bias correction in the cloud environment &#8212; Accessing and processing climate data remotely</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Accessing and processing climate data remotely" href="Data%20downloading%20ESGF.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Accessing and processing climate data remotely</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    Welcome to my Jupyter Book
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Data%20downloading%20ESGF.html">
   Accessing and processing climate data remotely
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Climate data bias correction in the cloud environment
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/faridfarhat/Subsetting-and-processing-climate-models-in-the-cloud-from-data-retrieval-to-bias-correction/master?urlpath=tree/docs/bias correction rcm.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/faridfarhat/Subsetting-and-processing-climate-models-in-the-cloud-from-data-retrieval-to-bias-correction/settings/"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/faridfarhat/Subsetting-and-processing-climate-models-in-the-cloud-from-data-retrieval-to-bias-correction/settings//issues/new?title=Issue%20on%20page%20%2Fbias correction rcm.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/bias correction rcm.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#intorduction-to-climate-model-ensemble-and-its-bias-correction">
   Intorduction to climate model ensemble and its bias correction.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#importing-required-python-packages">
   Importing required python packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-rcm-data-and-making-ensemble">
   Getting RCM data and making ensemble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subsetting-rcm-data">
     Subsetting RCM data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-ensemble-of-rcm-models">
     Making ensemble of RCM models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uploading-and-formating-observed-data">
   Uploading and formating observed data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-bias-correction-algorithms-on-rcm-ensemble">
   Applying bias correction algorithms on RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluating-bias-corrected-rcm-ensemble">
   Evaluating bias corrected RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accuracy-assessment-of-bias-corrected-rcm-ensemble">
   Accuracy assessment of bias corrected RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subsetting-gcm-data">
   Subsetting GCM data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-bias-correction-algorithms-on-gcm">
   Applying bias correction algorithms on GCM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accuracy-assessment-of-bias-corrected-gcm">
   Accuracy assessment of bias corrected GCM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Climate data bias correction in the cloud environment</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#intorduction-to-climate-model-ensemble-and-its-bias-correction">
   Intorduction to climate model ensemble and its bias correction.
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#importing-required-python-packages">
   Importing required python packages
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#getting-rcm-data-and-making-ensemble">
   Getting RCM data and making ensemble
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#subsetting-rcm-data">
     Subsetting RCM data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#making-ensemble-of-rcm-models">
     Making ensemble of RCM models
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#uploading-and-formating-observed-data">
   Uploading and formating observed data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-bias-correction-algorithms-on-rcm-ensemble">
   Applying bias correction algorithms on RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#evaluating-bias-corrected-rcm-ensemble">
   Evaluating bias corrected RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accuracy-assessment-of-bias-corrected-rcm-ensemble">
   Accuracy assessment of bias corrected RCM ensemble
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#subsetting-gcm-data">
   Subsetting GCM data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#applying-bias-correction-algorithms-on-gcm">
   Applying bias correction algorithms on GCM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#accuracy-assessment-of-bias-corrected-gcm">
   Accuracy assessment of bias corrected GCM
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="climate-data-bias-correction-in-the-cloud-environment">
<h1>Climate data bias correction in the cloud environment<a class="headerlink" href="#climate-data-bias-correction-in-the-cloud-environment" title="Permalink to this headline">#</a></h1>
<p>The document demonstrates how to get climate climate model data from online website and make their ensemble. Then extract data for desired point/points/boundary, implement bias correction, compute several statistics to evaluate bias corrected data, visualize data in different temporal graphs.</p>
<section id="intorduction-to-climate-model-ensemble-and-its-bias-correction">
<h2>Intorduction to climate model ensemble and its bias correction.<a class="headerlink" href="#intorduction-to-climate-model-ensemble-and-its-bias-correction" title="Permalink to this headline">#</a></h2>
<p>Downloading and processing of climate models are a tedious task that can take sigfniciant time. Especailly, if the user is interested in evaluating ensemble of multiple models because each model has to be downloaded and processed seperately. In addition, storing and archiving data from multiple models requires significant storage hardware, it is not easy to transfer this data from one machine to the other either. Even after downloading and storing this data, combining them to an ensemble requires additional workflow and hard drive memory.</p>
<p>To overcome above-mentioned challenges, this manual applies open-source python packages to retrieve and process climate data from OPenDAP over the cloud. The optimum advantage of the method is that we first access to the climate data servers and filter data to our particular region of interest (either a single point or boundary). This way data volume reduce sufficiently and the post processing can be performed faster. Therefore, unlike the usual data downloading/processing, one does not need to process data of a model for the entire globe (GCM) or a domain (RCM).</p>
<p>As a practical example, the document shows how to process historical pr for Baguio meteo sation, from an ensemble (3 models) of RCM-SEA. In doing this, inteneded user first needs to define several parameters for the data they want, such as domain, variable, time frequency, ensemble, model and so on. It is also needed to specify coordinate or region to process the data. Then using xarray, climate data will be subset for the region of interest.</p>
<p>After data from multiple model is acquired, they have to be combined into an ensemble. The resulting ensemble needs bias adjustment. Here, several bias correction methods, available in the xclim package, applied to remove bias in the data. In the end, accuracy of bias adjusted data is also evaluated</p>
</section>
<section id="importing-required-python-packages">
<h2>Importing required python packages<a class="headerlink" href="#importing-required-python-packages" title="Permalink to this headline">#</a></h2>
<p>Before proceeding, the some packages have to be installed in your local machine, anaconda environment. Then import the packages as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">xclim</span> <span class="k">as</span> <span class="nn">xc</span>
<span class="kn">from</span> <span class="nn">xclim</span> <span class="kn">import</span> <span class="n">sdba</span>
<span class="kn">from</span> <span class="nn">xclim</span> <span class="kn">import</span> <span class="n">ensembles</span>
<span class="kn">import</span> <span class="nn">xskillscore</span> <span class="k">as</span> <span class="nn">xs</span>
<span class="kn">import</span> <span class="nn">requests</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">drkz_search</span><span class="p">(</span><span class="n">server</span><span class="o">=</span><span class="s2">&quot;http://esgf-data.dkrz.de/esg-search/search&quot;</span><span class="p">,</span>
                <span class="n">files_type</span><span class="o">=</span><span class="s2">&quot;OPENDAP&quot;</span><span class="p">,</span> <span class="n">local_node</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="s2">&quot;CORDEX&quot;</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;application</span><span class="si">%2F</span><span class="s2">solr%2Bjson&quot;</span><span class="p">,</span>
                <span class="n">use_csrf</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">search</span><span class="p">):</span>
    <span class="n">client</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
    <span class="n">payload</span> <span class="o">=</span> <span class="n">search</span>
    <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;project&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">project</span>
    <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">=</span> <span class="s2">&quot;File&quot;</span>
    <span class="k">if</span> <span class="n">local_node</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;distrib&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
    <span class="k">if</span> <span class="n">use_csrf</span><span class="p">:</span>
        <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;csrftoken&#39;</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">cookies</span><span class="p">:</span>
            <span class="c1"># Django 1.6 and up</span>
            <span class="n">csrftoken</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;csrftoken&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># older versions</span>
            <span class="n">csrftoken</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;csrf&#39;</span><span class="p">]</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;csrfmiddlewaretoken&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">csrftoken</span>

    <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;format&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">format</span>

    <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">numFound</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">all_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">files_type</span> <span class="o">=</span> <span class="n">files_type</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
    <span class="k">while</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">numFound</span><span class="p">:</span>
        <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset</span>
        <span class="n">url_keys</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">payload</span><span class="p">:</span>
            <span class="n">url_keys</span> <span class="o">+=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">payload</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>

        <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">/?</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">server</span><span class="p">,</span> <span class="s2">&quot;&amp;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">url_keys</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">r</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;response&quot;</span><span class="p">]</span>
        <span class="n">numFound</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">resp</span><span class="p">[</span><span class="s2">&quot;numFound&quot;</span><span class="p">])</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">resp</span><span class="p">[</span><span class="s2">&quot;docs&quot;</span><span class="p">]</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">resp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]))</span>
            <span class="n">url</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;url&quot;</span><span class="p">]:</span>
                <span class="n">sp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">sp</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">files_type</span><span class="p">:</span>
                    <span class="n">all_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.html&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">all_files</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="getting-rcm-data-and-making-ensemble">
<h2>Getting RCM data and making ensemble<a class="headerlink" href="#getting-rcm-data-and-making-ensemble" title="Permalink to this headline">#</a></h2>
<p>Now the we defined the function. Use the function to to filter all RCM daily pr for SEA domain and ensemble r1i1p1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rcm</span> <span class="o">=</span> <span class="n">drkz_search</span><span class="p">(</span><span class="n">project</span><span class="o">=</span><span class="s1">&#39;CORDEX&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;pr&#39;</span><span class="p">,</span> <span class="n">domain</span> <span class="o">=</span> <span class="s1">&#39;SEA-22&#39;</span><span class="p">,</span><span class="n">experiment</span><span class="o">=</span><span class="s1">&#39;historical&#39;</span><span class="p">,</span><span class="n">time_frequency</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span><span class="n">ensemble</span><span class="o">=</span><span class="s1">&#39;r1i1p1&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;domain=SEA-22&amp;experiment=historical&amp;time_frequency=day&amp;ensemble=r1i1p1&amp;project=CORDEX&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=0
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;domain=SEA-22&amp;experiment=historical&amp;time_frequency=day&amp;ensemble=r1i1p1&amp;project=CORDEX&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=10
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;domain=SEA-22&amp;experiment=historical&amp;time_frequency=day&amp;ensemble=r1i1p1&amp;project=CORDEX&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=20
</pre></div>
</div>
</div>
</div>
<p>In the following data is printed to see the number of models and data period, which shows three RCM models having historical data over 1970-2005. Then open the one of the files and explore metadata such as longtitude, latiture, time and other variables of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rcm</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19700101-19701230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19710101-19751230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19760101-19801230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19810101-19851230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19860101-19901230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19910101-19951230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19960101-20001230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_20010101-20051230.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19700101-19701231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19710101-19751231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19760101-19801231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19810101-19851231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19860101-19901231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19910101-19951231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_19960101-20001231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MPI-M-MPI-ESM-LR/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MPI-M-MPI-ESM-LR_historical_r1i1p1_GERICS-REMO2015_v1_day_20010101-20051231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19700101-19701231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19710101-19751231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19760101-19801231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19810101-19851231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19860101-19901231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19910101-19951231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_19960101-20001231.nc&#39;,
 &#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/NCC-NorESM1-M/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_NCC-NorESM1-M_historical_r1i1p1_GERICS-REMO2015_v1_day_20010101-20051231.nc&#39;]
</pre></div>
</div>
</div>
</div>
<p>Now open the first file data and check metadata which is needed for data extraction later. For example, reading name of varaibles including lon, lat, precipition (pr), and time. This might be different for each model, then every models needs to be checked, in this case all models have same variable names and attributes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#open first data file to see variables</span>
<span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">rcm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>syntax error, unexpected $end, expecting SCAN_ATTR or SCAN_DATASET or SCAN_ERROR
context: ^
</pre></div>
</div>
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/file_manager.py:201,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">200</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">201</span>     <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">202</span> <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/lru_cache.py:55,</span> in <span class="ni">LRUCache.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lock</span><span class="p">:</span>
<span class="ne">---&gt; </span><span class="mi">55</span>     <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
<span class="g g-Whitespace">     </span><span class="mi">56</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">move_to_end</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

<span class="ne">KeyError</span>: [&lt;class &#39;netCDF4._netCDF4.Dataset&#39;&gt;, (&#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19700101-19701230.nc&#39;,), &#39;r&#39;, ((&#39;clobber&#39;, True), (&#39;diskless&#39;, False), (&#39;format&#39;, &#39;NETCDF4&#39;), (&#39;persist&#39;, False))]

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="ne">OSError</span><span class="g g-Whitespace">                                   </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">line</span> <span class="mi">2</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="c1">#open first data file to see variables</span>
<span class="ne">----&gt; </span><span class="mi">2</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">rcm</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/api.py:539,</span> in <span class="ni">open_dataset</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">527</span> <span class="n">decoders</span> <span class="o">=</span> <span class="n">_resolve_decoders_kwargs</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">528</span>     <span class="n">decode_cf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">529</span>     <span class="n">open_backend_dataset_parameters</span><span class="o">=</span><span class="n">backend</span><span class="o">.</span><span class="n">open_dataset_parameters</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>     <span class="n">decode_coords</span><span class="o">=</span><span class="n">decode_coords</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">538</span> <span class="n">overwrite_encoded_chunks</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;overwrite_encoded_chunks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">539</span> <span class="n">backend_ds</span> <span class="o">=</span> <span class="n">backend</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">540</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">541</span>     <span class="n">drop_variables</span><span class="o">=</span><span class="n">drop_variables</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">542</span>     <span class="o">**</span><span class="n">decoders</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">543</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">544</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">545</span> <span class="n">ds</span> <span class="o">=</span> <span class="n">_dataset_from_backend_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">546</span>     <span class="n">backend_ds</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">547</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">555</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span> <span class="k">return</span> <span class="n">ds</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:555,</span> in <span class="ni">NetCDF4BackendEntrypoint.open_dataset</span><span class="nt">(self, filename_or_obj, mask_and_scale, decode_times, concat_characters, decode_coords, drop_variables, use_cftime, decode_timedelta, group, mode, format, clobber, diskless, persist, lock, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">534</span> <span class="k">def</span> <span class="nf">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">535</span>     <span class="bp">self</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">536</span>     <span class="n">filename_or_obj</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">551</span>     <span class="n">autoclose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">552</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">554</span>     <span class="n">filename_or_obj</span> <span class="o">=</span> <span class="n">_normalize_path</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">555</span>     <span class="n">store</span> <span class="o">=</span> <span class="n">NetCDF4DataStore</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">556</span>         <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">557</span>         <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">558</span>         <span class="nb">format</span><span class="o">=</span><span class="nb">format</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">559</span>         <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">560</span>         <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">561</span>         <span class="n">diskless</span><span class="o">=</span><span class="n">diskless</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">562</span>         <span class="n">persist</span><span class="o">=</span><span class="n">persist</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">563</span>         <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">564</span>         <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">565</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">567</span>     <span class="n">store_entrypoint</span> <span class="o">=</span> <span class="n">StoreBackendEntrypoint</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">568</span>     <span class="k">with</span> <span class="n">close_on_error</span><span class="p">(</span><span class="n">store</span><span class="p">):</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:384,</span> in <span class="ni">NetCDF4DataStore.open</span><span class="nt">(cls, filename, mode, format, group, clobber, diskless, persist, lock, lock_maker, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">378</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>     <span class="n">clobber</span><span class="o">=</span><span class="n">clobber</span><span class="p">,</span> <span class="n">diskless</span><span class="o">=</span><span class="n">diskless</span><span class="p">,</span> <span class="n">persist</span><span class="o">=</span><span class="n">persist</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="nb">format</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span> <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span> <span class="n">manager</span> <span class="o">=</span> <span class="n">CachingFileManager</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">382</span>     <span class="n">netCDF4</span><span class="o">.</span><span class="n">Dataset</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">384</span> <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">manager</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">lock</span><span class="o">=</span><span class="n">lock</span><span class="p">,</span> <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">)</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:332,</span> in <span class="ni">NetCDF4DataStore.__init__</span><span class="nt">(self, manager, group, mode, lock, autoclose)</span>
<span class="g g-Whitespace">    </span><span class="mi">330</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span> <span class="o">=</span> <span class="n">group</span>
<span class="g g-Whitespace">    </span><span class="mi">331</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
<span class="ne">--&gt; </span><span class="mi">332</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">data_model</span>
<span class="g g-Whitespace">    </span><span class="mi">333</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ds</span><span class="o">.</span><span class="n">filepath</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">334</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_remote</span> <span class="o">=</span> <span class="n">is_remote_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:393,</span> in <span class="ni">NetCDF4DataStore.ds</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">391</span> <span class="nd">@property</span>
<span class="g g-Whitespace">    </span><span class="mi">392</span> <span class="k">def</span> <span class="nf">ds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">393</span>     <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire</span><span class="p">()</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/netCDF4_.py:387,</span> in <span class="ni">NetCDF4DataStore._acquire</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">386</span> <span class="k">def</span> <span class="nf">_acquire</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needs_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">387</span>     <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_manager</span><span class="o">.</span><span class="n">acquire_context</span><span class="p">(</span><span class="n">needs_lock</span><span class="p">)</span> <span class="k">as</span> <span class="n">root</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">388</span>         <span class="n">ds</span> <span class="o">=</span> <span class="n">_nc4_require_group</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">389</span>     <span class="k">return</span> <span class="n">ds</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/contextlib.py:135,</span> in <span class="ni">_GeneratorContextManager.__enter__</span><span class="nt">(self)</span>
<span class="g g-Whitespace">    </span><span class="mi">133</span> <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
<span class="g g-Whitespace">    </span><span class="mi">134</span> <span class="k">try</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">135</span>     <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gen</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">136</span> <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">137</span>     <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;generator didn&#39;t yield&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/file_manager.py:189,</span> in <span class="ni">CachingFileManager.acquire_context</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span> <span class="k">def</span> <span class="nf">acquire_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">needs_lock</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>     <span class="sd">&quot;&quot;&quot;Context manager for acquiring a file.&quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">189</span>     <span class="n">file</span><span class="p">,</span> <span class="n">cached</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acquire_with_cache_info</span><span class="p">(</span><span class="n">needs_lock</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>     <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>         <span class="k">yield</span> <span class="n">file</span>

<span class="nn">File ~/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/backends/file_manager.py:207,</span> in <span class="ni">CachingFileManager._acquire_with_cache_info</span><span class="nt">(self, needs_lock)</span>
<span class="g g-Whitespace">    </span><span class="mi">205</span>     <span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">206</span>     <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;mode&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
<span class="ne">--&gt; </span><span class="mi">207</span> <span class="n">file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_opener</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;w&quot;</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>     <span class="c1"># ensure file doesn&#39;t get overridden when opened again</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>     <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

<span class="nn">File src/netCDF4/_netCDF4.pyx:2463,</span> in <span class="ni">netCDF4._netCDF4.Dataset.__init__</span><span class="nt">()</span>

<span class="nn">File src/netCDF4/_netCDF4.pyx:2026,</span> in <span class="ni">netCDF4._netCDF4._ensure_nc_success</span><span class="nt">()</span>

<span class="ne">OSError</span>: [Errno -90] NetCDF: file not found: b&#39;http://esgf1.dkrz.de/thredds/dodsC/cordex/cordex/output/SEA-22/GERICS/MOHC-HadGEM2-ES/historical/r1i1p1/GERICS-REMO2015/v1/day/pr/v20191015/pr_SEA-22_MOHC-HadGEM2-ES_historical_r1i1p1_GERICS-REMO2015_v1_day_19700101-19701230.nc&#39;
</pre></div>
</div>
</div>
</div>
<section id="subsetting-rcm-data">
<h3>Subsetting RCM data<a class="headerlink" href="#subsetting-rcm-data" title="Permalink to this headline">#</a></h3>
<p>Now we know the variables and metadata. Using this information we will extract data according to a point, a rainfall gauge station located in Baguio, Benguet. Here pr will be extracted for the whole historical available data (1970-2005), from all three models, for the the given coordinate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">y</span><span class="o">=</span><span class="mf">16.4</span> <span class="c1">#Define latitue (baguio station).</span>
<span class="n">x</span><span class="o">=</span><span class="mf">120.6</span> <span class="c1">#Define longitude (baguio station).</span>
<span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm/day&#39;</span> <span class="c1">#Define the unit for which data to be changed into.</span>
<span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;pr&#39;</span> <span class="c1"># Define variable</span>

<span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rcm</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">assign_coords</span><span class="p">({</span><span class="s1">&#39;model_id&#39;</span><span class="p">:</span><span class="n">data</span><span class="o">.</span><span class="n">driving_model_id</span><span class="p">})</span> <span class="c1">#add a new dimension to retrieve each model seperately later.</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">rlat</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">rlon</span><span class="o">=</span><span class="n">x</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1">#check metadata of data, change this name (lon/lat) if needed.</span>
    <span class="c1">#ds.append(data[&#39;pr&#39;])</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xc</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">convert_units_to</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">unit</span><span class="p">)</span> <span class="c1"># changing unit to mm/day</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="making-ensemble-of-rcm-models">
<h3>Making ensemble of RCM models<a class="headerlink" href="#making-ensemble-of-rcm-models" title="Permalink to this headline">#</a></h3>
<p>Now data from all models are filtered to the given geographic location. To make ensemble of each model, calendar of all models should be same. Also, spatial resolution has to be same. If it is different, then those models need to be regridded to a common spatial resolution where each model has the same resolution. In this sample dataset all models have same spatial resolution, meaning no spatial regridding is required. We only change the calendar to gregorian and fill the missing dates with zeros. This data will be referred to as RCM ensemble in the successive steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">dn</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">ds</span><span class="p">:</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="n">missing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">dn</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">da</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
</pre></div>
</div>
</div>
</div>
<p>Next we make an xarray dataset by concatenating along the model dimension. This will make an xarray dataset that store pr of each model along the time dimension as shown below. After making this array, we can average output of the three models in order to make an ensemble.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ens</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dn</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s1">&#39;pr&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataset</span><span class="p">()</span> <span class="c1">#making an xarray dataset to store pr of each model</span>
<span class="n">ens</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;model_id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1">#this is to avoid repeated coordinate</span>
<span class="n">ens_mean</span> <span class="o">=</span> <span class="n">ens</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span><span class="n">keep_attrs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#average of each model</span>
</pre></div>
</div>
</div>
</div>
<p>To check the individual model and their ensemble (mean), the interannual variability is plotted as below.This enemble model will be used for bias correction later.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ens</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">hue</span><span class="o">=</span><span class="s1">&#39;model_id&#39;</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;MOHC-HadGEM2-ES&#39;</span><span class="p">,</span> <span class="s1">&#39;MPI-M-MPI-ESM-LR&#39;</span><span class="p">,</span> <span class="s1">&#39;NCC-NorESM1-M&#39;</span><span class="p">])</span>
<span class="n">ens_mean</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intern-annual variability for each model and their ensemble&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Intern-annual variability for each model and their ensemble&#39;)
</pre></div>
</div>
<img alt="_images/bias correction rcm_18_1.png" src="_images/bias correction rcm_18_1.png" />
</div>
</div>
</section>
</section>
<section id="uploading-and-formating-observed-data">
<h2>Uploading and formating observed data<a class="headerlink" href="#uploading-and-formating-observed-data" title="Permalink to this headline">#</a></h2>
<p>In the second stage, it is needed to take a sample observed dataset and formatted according to an xarray dataarray. As example, daily rainfall from Baguio Benguet station (1981-2010) is used here. First read this data in a dataframe from the local directory where the data is located and it should be as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_excel</span><span class="p">(</span><span class="s1">&#39;/Users/farid/pCloud Drive/2. Peshawar/GIS and Maps/Peshawar CRVA/Bias correction/Baguio Benguet station rainfall 1981-2010.xlsx&#39;</span><span class="p">)</span> <span class="c1">#directory where data located</span>
<span class="n">df</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>date</th>
      <th>pr</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1981-01-01</td>
      <td>0.70</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1981-01-02</td>
      <td>18.60</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1981-01-03</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1981-01-04</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1981-01-05</td>
      <td>2.00</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>7300</th>
      <td>2000-12-27</td>
      <td>2.80</td>
    </tr>
    <tr>
      <th>7301</th>
      <td>2000-12-28</td>
      <td>13.00</td>
    </tr>
    <tr>
      <th>7302</th>
      <td>2000-12-29</td>
      <td>0.00</td>
    </tr>
    <tr>
      <th>7303</th>
      <td>2000-12-30</td>
      <td>25.40</td>
    </tr>
    <tr>
      <th>7304</th>
      <td>2000-12-31</td>
      <td>1.40</td>
    </tr>
  </tbody>
</table>
<p>7305 rows  2 columns</p>
</div></div></div>
</div>
<p>Now change this observed dataset into a dataarray as below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#creat a dataarray from the observed dataset</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">cftime_range</span><span class="p">(</span><span class="s2">&quot;1981-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2000-12-31&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<span class="n">ref</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
    <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">pr</span><span class="p">),</span>
    <span class="n">dims</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,),</span>
    <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">t</span><span class="p">},</span>
    <span class="n">attrs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;mm/day&quot;</span><span class="p">},</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ref&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Before proceeding, the climate data and observed data must be in the same calendar. Here we convert both into Gregorian calendar, this will replace missing data with 0 in both datasets. In addition, each dataset (observed, and climate data) has to have same period. Both dataset time series are plotted to see their temporal trend and overall check.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">ens_mean</span><span class="o">.</span><span class="n">pr</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span><span class="s1">&#39;2000&#39;</span><span class="p">))</span>
<span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="n">missing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">ref</span><span class="o">=</span><span class="n">ref</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="n">missing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span>
<span class="n">ax</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">date</span><span class="p">,</span><span class="n">df</span><span class="o">.</span><span class="n">pr</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Reference&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="p">,</span><span class="n">ds</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;RCM ensemble&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Rainfall (mm/day)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Daily rainfall from reference (observation) and RCM ensemble (1981-2000)&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x19c2f2e00&gt;
</pre></div>
</div>
<img alt="_images/bias correction rcm_24_2.png" src="_images/bias correction rcm_24_2.png" />
</div>
</div>
</section>
<section id="applying-bias-correction-algorithms-on-rcm-ensemble">
<h2>Applying bias correction algorithms on RCM ensemble<a class="headerlink" href="#applying-bias-correction-algorithms-on-rcm-ensemble" title="Permalink to this headline">#</a></h2>
<p>Now observed and climate data is ready for bias correction (BC) <span id="id1">[<a class="reference internal" href="#id8" title="Michel Dqu. Frequency of precipitation and temperature extremes over france in an anthropogenic scenario: model results and statistical correction according to observed values. Global and Planetary Change, 57(1):16-26, 2007. Extreme Climatic Events. URL: https://www.sciencedirect.com/science/article/pii/S0921818106002748, doi:https://doi.org/10.1016/j.gloplacha.2006.11.030.">Dqu, 2007</a>]</span>. Here, 5 BC methods used, empirical quantile mapping (QM), linear scaling (LS), local intensity scaling (LOCI), deterending quantile mapping (DQ), quantile delta mapping (QDM). As following, each of this method are trained on observation and climate data (RCM ensemble) and then applied to adjust data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#quantile mapping bias correction</span>
<span class="n">QM_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">EmpiricalQuantileMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">QM_adjust</span> <span class="o">=</span> <span class="n">QM_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extrapolation</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="c1">#linear scaling mapping bias correction</span>
<span class="n">LS_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">Scaling</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;time.month&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">LS_adjust</span> <span class="o">=</span> <span class="n">LS_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

<span class="c1">#local intensity scaling bias correction</span>
<span class="n">LOCI_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">LOCI</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="s1">&#39;1 mm/day&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span>
<span class="n">LOCI_adjust</span> <span class="o">=</span> <span class="n">LOCI_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="c1">#deternding quantile mapping</span>
<span class="n">QD</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">DetrendedQuantileMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">QD_adjust</span> <span class="o">=</span> <span class="n">QD</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extrapolation</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

<span class="c1">#quantile delta mapping</span>
<span class="n">QDM</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">QuantileDeltaMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span>
<span class="n">QDM_adjust</span> <span class="o">=</span> <span class="n">QDM</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:449: UserWarning: Using DQM with a grouping other than &#39;dayofyear&#39; is not recommended (received time.month).
  warn(
</pre></div>
</div>
</div>
</div>
</section>
<section id="evaluating-bias-corrected-rcm-ensemble">
<h2>Evaluating bias corrected RCM ensemble<a class="headerlink" href="#evaluating-bias-corrected-rcm-ensemble" title="Permalink to this headline">#</a></h2>
<p>At this stage, all time sereis data from including reference, RCM ensemble, and bias adjusted data are evaluated at daily and monthly time steps. Below shows long term average for each day and month over the historical period, 1981-2000. LS method performs better compared to other methods as can be seen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn&#39;</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bias corrected data versus RCM ensemble and reference (observation), daily and monthly mean over 1981-2000&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#plot daily average</span>
<span class="n">ref</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference&quot;</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RCM ensemble&quot;</span><span class="p">)</span>
<span class="n">QM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">LS_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LS&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">LOCI_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LOCI&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">QD_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">QDM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QDM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;pr (mm)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;days of the year&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Legend&#39;</span><span class="p">,</span><span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">#plot monthly average</span>
<span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;RCM ensemble&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">LS_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LS&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">LOCI_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LOCI&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QD_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QDM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QDM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Months&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;pr (mm)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Legend&#39;</span><span class="p">,</span><span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x19be5b490&gt;
</pre></div>
</div>
<img alt="_images/bias correction rcm_28_1.png" src="_images/bias correction rcm_28_1.png" />
</div>
</div>
</section>
<section id="accuracy-assessment-of-bias-corrected-rcm-ensemble">
<h2>Accuracy assessment of bias corrected RCM ensemble<a class="headerlink" href="#accuracy-assessment-of-bias-corrected-rcm-ensemble" title="Permalink to this headline">#</a></h2>
<p>The accuracy of RCM ensemble versus observed, bias adjusted versus observed time series is evaluated through performance criteria (Objective function). Coefficient of determination (R2) and Pearson r correlations are used to assess data accuracy. To be noted that these metrics are calculated based on monthly time series. When R2 and Pearson r reach close to 1, two datasets show better correlcation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">criteria</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Coefficient of Determination (R2)&#39;</span><span class="p">,</span><span class="s1">&#39;Pearson r&#39;</span><span class="p">]</span>
<span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="n">o</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="s1">&#39;1m&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">r2</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">pearson_r</span> <span class="o">=</span> <span class="n">xs</span><span class="o">.</span><span class="n">pearson_r</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">r2</span><span class="p">,</span><span class="n">pearson_r</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#calculate performance criteria</span>
<span class="n">gcm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">ds</span><span class="p">)</span>
<span class="n">qm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QM_adjust</span><span class="p">)</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">LS_adjust</span><span class="p">)</span>
<span class="n">loci</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">LOCI_adjust</span><span class="p">)</span>
<span class="n">qd</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QD_adjust</span><span class="p">)</span>
<span class="n">qdm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QDM_adjust</span><span class="p">)</span>
<span class="c1">#tabulating and plotting data</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;r1&#39;</span><span class="p">:</span><span class="n">criteria</span><span class="p">,</span><span class="s1">&#39;RCM ensemble&#39;</span><span class="p">:</span><span class="n">gcm</span><span class="p">,</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span><span class="n">qm</span><span class="p">,</span> <span class="s1">&#39;LS&#39;</span><span class="p">:</span><span class="n">ls</span><span class="p">,</span> <span class="s1">&#39;LOCI&#39;</span><span class="p">:</span><span class="n">loci</span><span class="p">,</span><span class="s1">&#39;QD&#39;</span><span class="p">:</span><span class="n">qd</span><span class="p">,</span><span class="s1">&#39;QDM&#39;</span><span class="p">:</span><span class="n">qdm</span><span class="p">},</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;RCM ensemble&#39;</span><span class="p">,</span><span class="s1">&#39;QM&#39;</span><span class="p">,</span><span class="s1">&#39;LS&#39;</span><span class="p">,</span><span class="s1">&#39;LOCI&#39;</span><span class="p">,</span><span class="s1">&#39;QD&#39;</span><span class="p">,</span><span class="s1">&#39;QDM&#39;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Performance criteria&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;legend&#39;</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>RCM ensemble</th>
      <th>QM</th>
      <th>LS</th>
      <th>LOCI</th>
      <th>QD</th>
      <th>QDM</th>
    </tr>
    <tr>
      <th>Performance criteria</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coefficient of Determination (R2)</th>
      <td>-0.31</td>
      <td>0.26</td>
      <td>0.44</td>
      <td>0.36</td>
      <td>0.27</td>
      <td>0.24</td>
    </tr>
    <tr>
      <th>Pearson r</th>
      <td>0.68</td>
      <td>0.61</td>
      <td>0.69</td>
      <td>0.65</td>
      <td>0.60</td>
      <td>0.59</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/bias correction rcm_32_1.png" src="_images/bias correction rcm_32_1.png" />
</div>
</div>
</section>
<section id="subsetting-gcm-data">
<h2>Subsetting GCM data<a class="headerlink" href="#subsetting-gcm-data" title="Permalink to this headline">#</a></h2>
<p>Similary to previous steps, data from CMIP6 model (HadGEM3-GC31-MM) is acquired for the Baguio station. Data is filtered to point of interest and time period, Baguio station from 1981-2000. This data will be referred to as GCM in the successive steps.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">cmip6</span> <span class="o">=</span> <span class="n">drkz_search</span><span class="p">(</span><span class="n">project</span> <span class="o">=</span> <span class="s1">&#39;CMIP6&#39;</span><span class="p">,</span> <span class="n">variable</span><span class="o">=</span><span class="s1">&#39;pr&#39;</span><span class="p">,</span>  <span class="n">source_id</span> <span class="o">=</span> <span class="s1">&#39;HadGEM3-GC31-MM&#39;</span><span class="p">,</span> <span class="n">experiment_id</span><span class="o">=</span><span class="s1">&#39;hist-1950&#39;</span><span class="p">,</span><span class="n">frequency</span><span class="o">=</span><span class="s2">&quot;day&quot;</span><span class="p">,</span><span class="n">variant_label</span> <span class="o">=</span> <span class="s1">&#39;r1i1p1f1&#39;</span><span class="p">,</span><span class="n">nominal_resolution</span> <span class="o">=</span> <span class="s1">&#39;100 km&#39;</span><span class="p">)</span>


<span class="n">period</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s1">&#39;1981&#39;</span><span class="p">,</span><span class="s1">&#39;2000&#39;</span><span class="p">)</span> <span class="c1">#Define period. </span>
<span class="n">y</span><span class="o">=</span><span class="mf">16.4</span> <span class="c1">#Define latitue (baguio station).</span>
<span class="n">x</span><span class="o">=</span><span class="mf">120.6</span> <span class="c1">#Define longitude (baguio station).</span>
<span class="n">n</span><span class="o">=</span><span class="mi">34</span> <span class="c1">#no of files/urls to process starting from latest</span>
<span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;mm/day&#39;</span> <span class="c1">#Define the unit for which data to be changed into.</span>
<span class="n">var</span> <span class="o">=</span> <span class="s1">&#39;pr&#39;</span> <span class="c1"># Define variable</span>

<span class="n">ds</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cmip6</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">cmip6</span><span class="p">)</span><span class="o">-</span><span class="n">n</span><span class="p">:</span><span class="nb">len</span><span class="p">(</span><span class="n">cmip6</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]:</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">lat</span><span class="o">=</span><span class="n">y</span><span class="p">,</span><span class="n">lon</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span> <span class="c1">#check metadata of data, change this name (lon/lat) if needed.</span>
    <span class="n">ds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>

<span class="n">ds</span> <span class="o">=</span> <span class="n">xc</span><span class="o">.</span><span class="n">units</span><span class="o">.</span><span class="n">convert_units_to</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="n">var</span><span class="p">],</span> <span class="n">unit</span><span class="p">)</span> <span class="c1"># changing units</span>
<span class="n">ds</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">period</span><span class="p">)</span> <span class="c1">#slicing data to the period of interest.</span>

<span class="n">ds</span><span class="o">=</span><span class="n">ds</span><span class="o">.</span><span class="n">convert_calendar</span><span class="p">(</span><span class="s1">&#39;gregorian&#39;</span><span class="p">,</span> <span class="n">align_on</span><span class="o">=</span><span class="s1">&#39;year&#39;</span><span class="p">,</span><span class="n">missing</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=0
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=10
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=20
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=30
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=40
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=50
http://esgf-data.dkrz.de/esg-search/search/?variable=pr&amp;source_id=HadGEM3-GC31-MM&amp;experiment_id=hist-1950&amp;frequency=day&amp;variant_label=r1i1p1f1&amp;nominal_resolution=100 km&amp;project=CMIP6&amp;type=File&amp;distrib=false&amp;format=application%2Fsolr%2Bjson&amp;offset=60
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xarray/coding/cftime_offsets.py:1130: FutureWarning: Argument `closed` is deprecated in favor of `inclusive`.
  return pd.date_range(
</pre></div>
</div>
</div>
</div>
</section>
<section id="applying-bias-correction-algorithms-on-gcm">
<h2>Applying bias correction algorithms on GCM<a class="headerlink" href="#applying-bias-correction-algorithms-on-gcm" title="Permalink to this headline">#</a></h2>
<p>Similar to previous step, 5 BC methods are applied to remove in GCM, empirical quantile mapping (QM), linear scaling (LS), local intensity scaling (LOCI), deterending quantile mapping (DQ), quantile delta mapping (QDM). As following, each of this method are trained on observation and climate data (GCM) and then applied to adjust data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#quantile mapping bias correction</span>
<span class="n">QM_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">EmpiricalQuantileMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">QM_adjust</span> <span class="o">=</span> <span class="n">QM_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extrapolation</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="c1">#linear scaling mapping bias correction</span>
<span class="n">LS_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">Scaling</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;time.dayofyear&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">LS_adjust</span> <span class="o">=</span> <span class="n">LS_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>

<span class="c1">#local intensity scaling bias correction</span>
<span class="n">LOCI_train</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">LOCI</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span><span class="n">thresh</span><span class="o">=</span><span class="s1">&#39;1 mm/day&#39;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span>
<span class="n">LOCI_adjust</span> <span class="o">=</span> <span class="n">LOCI_train</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;linear&quot;</span><span class="p">)</span>

<span class="c1">#deternding quantile mapping</span>
<span class="n">QD</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">DetrendedQuantileMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">)</span>
<span class="n">QD_adjust</span> <span class="o">=</span> <span class="n">QD</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">,</span> <span class="n">extrapolation</span><span class="o">=</span><span class="s2">&quot;constant&quot;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s2">&quot;nearest&quot;</span><span class="p">)</span>

<span class="c1">#quantile delta mapping</span>
<span class="n">QDM</span> <span class="o">=</span> <span class="n">sdba</span><span class="o">.</span><span class="n">QuantileDeltaMapping</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">ds</span><span class="p">,</span> <span class="n">nquantiles</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span>
<span class="n">QDM_adjust</span> <span class="o">=</span> <span class="n">QDM</span><span class="o">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:118: UserWarning: Strange results could be returned when using dayofyear grouping on data defined in the proleptic_gregorian calendar 
  warn(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:118: UserWarning: Strange results could be returned when using dayofyear grouping on data defined in the proleptic_gregorian calendar 
  warn(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:118: UserWarning: Strange results could be returned when using dayofyear grouping on data defined in the proleptic_gregorian calendar 
  warn(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:118: UserWarning: Strange results could be returned when using dayofyear grouping on data defined in the proleptic_gregorian calendar 
  warn(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:118: UserWarning: Strange results could be returned when using dayofyear grouping on data defined in the proleptic_gregorian calendar 
  warn(
/Users/farid/Abaconda3/anaconda3/envs/geo_env/lib/python3.10/site-packages/xclim/sdba/adjustment.py:449: UserWarning: Using DQM with a grouping other than &#39;dayofyear&#39; is not recommended (received time.month).
  warn(
</pre></div>
</div>
</div>
</div>
<p>At this stage, all time sereis data from including reference, GCM, and bias adjusted data are evaluated at daily and monthly time steps. Below shows long term average for each day and month over the historical period, 1981-2000. Emperical quantile mapping method performs better compared to other methods as can be seen.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s1">&#39;seaborn&#39;</span><span class="p">)</span>
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;xtick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span> 
<span class="n">matplotlib</span><span class="o">.</span><span class="n">rc</span><span class="p">(</span><span class="s1">&#39;ytick&#39;</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">tight_layout</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Bias corrected data versus GCM and reference (observation), daily and monthly mean over 1981-2000&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span><span class="n">x</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span><span class="n">y</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1">#plot daily average</span>
<span class="n">ref</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference&quot;</span><span class="p">)</span>
<span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GCM&quot;</span><span class="p">)</span>
<span class="n">QM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">LS_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LS&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">LOCI_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LOCI&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">QD_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">QDM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.dayofyear&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QDM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;pr (mm)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;days of the year&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Legend&#39;</span><span class="p">,</span><span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1">#plot monthly average</span>
<span class="p">(</span><span class="n">ref</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Reference&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;GCM&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">LS_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LS&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">LOCI_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;LOCI&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QD_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QD&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="n">QDM_adjust</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;time.month&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="p">)))</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;QDM&quot;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Months&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;pr (mm)&#39;</span><span class="p">,</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Legend&#39;</span><span class="p">,</span><span class="n">title_fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;matplotlib.legend.Legend at 0x19c2722c0&gt;
</pre></div>
</div>
<img alt="_images/bias correction rcm_38_1.png" src="_images/bias correction rcm_38_1.png" />
</div>
</div>
</section>
<section id="accuracy-assessment-of-bias-corrected-gcm">
<h2>Accuracy assessment of bias corrected GCM<a class="headerlink" href="#accuracy-assessment-of-bias-corrected-gcm" title="Permalink to this headline">#</a></h2>
<p>The accuracy of GCM versus observed, bias adjusted versus observed time series is evaluated through performance criteria (Objective function). Coefficient of determination (R2) and Pearson r correlations are used to assess data accuracy. To be noted that these metrics are calculated based on monthly time series. When R2 and Pearson r reach close to 1, two datasets show better correlcation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gcm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">ds</span><span class="p">)</span>
<span class="n">qm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QM_adjust</span><span class="p">)</span>
<span class="n">ls</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">LS_adjust</span><span class="p">)</span>
<span class="n">loci</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">LOCI_adjust</span><span class="p">)</span>
<span class="n">qd</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QD_adjust</span><span class="p">)</span>
<span class="n">qdm</span> <span class="o">=</span> <span class="n">error</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span><span class="n">QDM_adjust</span><span class="p">)</span>
<span class="c1">#tabulating and plotting data</span>
<span class="n">pd</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">display</span><span class="o">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{:,.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span>
<span class="n">data</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;r1&#39;</span><span class="p">:</span><span class="n">criteria</span><span class="p">,</span><span class="s1">&#39;GCM&#39;</span><span class="p">:</span><span class="n">gcm</span><span class="p">,</span> <span class="s1">&#39;QM&#39;</span><span class="p">:</span><span class="n">qm</span><span class="p">,</span> <span class="s1">&#39;LS&#39;</span><span class="p">:</span><span class="n">ls</span><span class="p">,</span> <span class="s1">&#39;LOCI&#39;</span><span class="p">:</span><span class="n">loci</span><span class="p">,</span><span class="s1">&#39;QD&#39;</span><span class="p">:</span><span class="n">qd</span><span class="p">,</span><span class="s1">&#39;QDM&#39;</span><span class="p">:</span><span class="n">qdm</span><span class="p">},</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GCM&#39;</span><span class="p">,</span><span class="s1">&#39;QM&#39;</span><span class="p">,</span><span class="s1">&#39;LS&#39;</span><span class="p">,</span><span class="s1">&#39;LOCI&#39;</span><span class="p">,</span><span class="s1">&#39;QD&#39;</span><span class="p">,</span><span class="s1">&#39;QDM&#39;</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">criteria</span><span class="p">)</span><span class="o">.</span><span class="n">rename_axis</span><span class="p">(</span><span class="s1">&#39;Performance criteria&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;legend&#39;</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>GCM</th>
      <th>QM</th>
      <th>LS</th>
      <th>LOCI</th>
      <th>QD</th>
      <th>QDM</th>
    </tr>
    <tr>
      <th>Performance criteria</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Coefficient of Determination (R2)</th>
      <td>0.30</td>
      <td>0.41</td>
      <td>0.39</td>
      <td>0.36</td>
      <td>0.22</td>
      <td>0.18</td>
    </tr>
    <tr>
      <th>Pearson r</th>
      <td>0.60</td>
      <td>0.69</td>
      <td>0.67</td>
      <td>0.65</td>
      <td>0.59</td>
      <td>0.58</td>
    </tr>
  </tbody>
</table>
</div></div><img alt="_images/bias correction rcm_40_1.png" src="_images/bias correction rcm_40_1.png" />
</div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>The comparison of raw model data from RCM ensemble and GCM suggests that RCM highly overestimate precipitation, while GCM underestimate precipitation. The correlation coefficeient (R2) for RCM ensemble and GCM is -0.2 and 0.3, which suggests that GCM raw data match well with observation when compared to RCM ensemble. It is also to be noted that pearson r shows better performance for RCM ensemble, pearson r for RCM ensemble and GCM is 0.68 and 0.6.</p>
<p>However, the analysis of bias corrected data from RCM ensemble and GCM shows an oppsite trend. The bias correction of RCM ensemble revealed that linear scaling (LS) performed well compared to other methods, R2 is 0.44 and pearson r is 0.69. Bias corrected GCM data showed that emporical quantile mapping (QM) performed better compared to other methods, R2 is 0.41 and pearson r is 0.69.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<div class="docutils container" id="id2">
<dl class="citation">
<dt class="label" id="id8"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Michel Dqu. Frequency of precipitation and temperature extremes over france in an anthropogenic scenario: model results and statistical correction according to observed values. <em>Global and Planetary Change</em>, 57(1):1626, 2007. Extreme Climatic Events. URL: <a class="reference external" href="https://www.sciencedirect.com/science/article/pii/S0921818106002748">https://www.sciencedirect.com/science/article/pii/S0921818106002748</a>, <a class="reference external" href="https://doi.org/https://doi.org/10.1016/j.gloplacha.2006.11.030">doi:https://doi.org/10.1016/j.gloplacha.2006.11.030</a>.</p>
</dd>
</dl>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "venv1kernel"
        },
        kernelOptions: {
            kernelName: "venv1kernel",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'venv1kernel'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="Data%20downloading%20ESGF.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Accessing and processing climate data remotely</p>
        </div>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Sameer Sarwary<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>